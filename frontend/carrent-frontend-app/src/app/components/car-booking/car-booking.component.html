<div class="car-booking-container">
  <div class="breadcrumb"><a href="/cars">Cars</a> &gt; Car booking</div>

  <h1>Car booking</h1>

  <section class="booking-section">
    <div class="booking-content">
      <div class="booking-form">
        <form [formGroup]="bookingForm">
          <!-- Personal Info Section -->
          <div class="section">
            <!-- For support agent, show "Clients info" with dropdown -->
            <h2 *ngIf="isSupport">Clients info</h2>
            <h2 *ngIf="!isSupport">Personal info</h2>

            <!-- Support agent view with client dropdown -->
            <div class="personal-info-card" *ngIf="isSupport">
              <div class="form-field">
                <label>Client</label>
                <div class="select-wrapper">
                  <select
                    class="client-select"
                    [value]="selectedClient?.id || ''"
                    (change)="onClientSelected($event)"
                  >
                    <option value="" disabled selected>Select a client</option>
                    <option *ngFor="let client of clients" [value]="client.id">
                      {{ client.fullName }}
                    </option>
                  </select>
                  <button type="button" class="save-btn">Save</button>
                </div>
              </div>
            </div>

            <!-- Client view with personal info display -->
            <div
              class="personal-info-card"
              *ngIf="!isSupport"
              formGroupName="personalInfo"
            >
              <div class="user-info">
                <div class="full-name">
                  {{ bookingForm.get("personalInfo.fullName")?.value }}
                </div>
                <div class="email">
                  {{ bookingForm.get("personalInfo.email")?.value }}
                </div>
                <div class="phone">
                  {{ bookingForm.get("personalInfo.phone")?.value }}
                </div>
              </div>
            </div>
          </div>

          <!-- Location Section -->
          <div class="section">
            <h2>Location</h2>
            <div class="location-card" formGroupName="location">
              <div class="form-field">
                <label>Pick-up location</label>
                <div class="select-wrapper">
                  <select 
                    formControlName="pickupLocation"
                    class="location-select"
                    (change)="onPickupLocationChanged($event)"
                  >
                    <option value="" disabled selected>Select pick-up location</option>
                    <option *ngFor="let location of locations" [value]="location.locationId">
                      {{ location.locationName }}
                    </option>
                  </select>
                  <button type="button" class="save-btn">Save</button>
                </div>
                <div *ngIf="isLocationInvalid('pickupLocation')" class="error-message">
                  Please select a pick-up location
                </div>
              </div>
              
              <div class="form-field">
                <label class="drop-off">Drop-off location</label>
                <div class="select-wrapper">
                  <select 
                    formControlName="dropoffLocation"
                    class="location-select"
                    (change)="onDropoffLocationChanged($event)"
                  >
                    <option value="" disabled selected>Select drop-off location</option>
                    <option *ngFor="let location of locations" [value]="location.locationId">
                      {{ location.locationName }}
                    </option>
                  </select>
                  <button type="button" class="save-btn">Save</button>
                </div>
                <div *ngIf="isLocationInvalid('dropoffLocation')" class="error-message">
                  Please select a drop-off location
                </div>
              </div>
            </div>
          </div>

          <!-- Dates & Time Section -->
          <div class="section">
            <h2>Dates & Time</h2>
            <div class="dates-card" formGroupName="dates">
              <div class="date-header">
                <div class="date-label">Pick-up date</div>
                <button type="button" class="change-btn" (click)="toggleCalendar()">
                  Change
                </button>
              </div>
              
              <div *ngIf="isCalendarOpen" class="calendar-container">
                <calendar
                  class="booking-calendar"
                  [externalToggle]="isCalendarOpen"
                  [initialStartDate]="dateFrom"
                  [initialEndDate]="dateTo"
                  [bookedDates]="bookedDatesFormatted"
                  (dateRangeSelected)="onDateRangeSelected($event)"
                >
                </calendar>
              </div>

              <div class="date-time-display">
                <div class="date-time-row">
                  <div class="date-time-value">
                    {{ dateFrom | date: 'MMMM d | HH:mm' }}
                  </div>
                </div>
                
                <div class="date-label drop-off-label">Drop-off date</div>
                <div class="date-time-row">
                  <div class="date-time-value">
                    {{ dateTo | date: 'MMMM d | HH:mm' }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Car Details and Confirmation Section -->
      <div class="car-details-section">
        <div class="car-details-container" *ngIf="selectedCar">
          <div class="car-image">
            <img
              [src]="selectedCar.images && selectedCar.images.length > 0 ? (selectedCar.images[0].url || selectedCar.images[0]) : 'assets/images/car-placeholder.jpg'"
              class="image-car"
              [alt]="selectedCar.brand + ' ' + selectedCar.model"
            />
          </div>
          <div class="car-info">
            <h3 class="car-title">
              {{ selectedCar.brand }} {{ selectedCar.model }} {{ selectedCar.year }}
            </h3>
            <p class="car-location">{{ selectedCar.location }}</p>

            <div class="pricing-info">
              <div class="total-section">
                <div class="total-label">Total</div>
                <div class="total-price">$ {{ totalPrice }}</div>
              </div>
              <div class="deposit-info">Deposit: $ {{ depositAmount }}</div>
              <button
                type="button"
                class="confirm-btn"
                (click)="confirmReservation()"
                [disabled]="!isFormValid() || (isSupport && !selectedClient)"
                [ngClass]="{
                  'disabled-btn': !isFormValid() || (isSupport && !selectedClient)
                }"
              >
                {{ getConfirmButtonText() }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>